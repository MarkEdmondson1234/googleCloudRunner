<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R on Cloud Run • googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="R on Cloud Run">
<meta property="og:description" content="googleCloudRunner">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-wrench"></span>
     
    Setup
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/setup.html">R Setup</a>
    </li>
    <li>
      <a href="../articles/setup-gcp.html">GCP Setup</a>
    </li>
    <li>
      <a href="../articles/git.html">Git Setup</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li>
  <a href="../articles/usecases.html">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>R on Cloud Run</h1>
            
            <h4 class="date">2020-06-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/blob/master/vignettes/cloudrun.Rmd"><code>vignettes/cloudrun.Rmd</code></a></small>
      <div class="hidden name"><code>cloudrun.Rmd</code></div>

    </div>

    
    
<p><a href="https://cloud.run">Cloud Run</a> is a service that lets you deploy container images without worrying about the underlying servers or infrastructure. It is called with <code><a href="../reference/cr_run.html">cr_run()</a></code>, or you can automate a deployment via <code><a href="../reference/cr_deploy_run.html">cr_deploy_run()</a></code>.</p>
<p>If you would like to have your R code react in realtime to events such as HTTP or Pub/Sub events, such as a website or API endpoint, Cloud Run is a good fit.</p>
<p>If you want to run scripts that can be triggered one time, setup to trigger on GitHub events or pub/sub, or scheduled using Cloud Scheduler then <a href="https://code.markedmondson.me/googleCloudRunner/articles/cloudbuild.html">Cloud Build</a> is more suited to your use case.</p>
<div id="quickstart---plumber-api" class="section level2">
<h2 class="hasAnchor">
<a href="#quickstart---plumber-api" class="anchor"></a>Quickstart - plumber API</h2>
<ol style="list-style-type: decimal">
<li>Make an R API via <a href="https://www.rplumber.io/">plumber</a> that contains entry file api.R. You can use the demo example in <code><a href="https://rdrr.io/r/base/system.file.html">system.file("example", package="googleCloudRunner")</a></code> if you like, which is reproduced below:</li>
</ol>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co">#' @get /</span>
<span class="co">#' @html</span>
<span class="kw">function</span>(){
  <span class="st">"&lt;html&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/html&gt;"</span>
}


<span class="co">#' @get /hello</span>
<span class="co">#' @html</span>
<span class="kw">function</span>(){
  <span class="st">"&lt;html&gt;&lt;h1&gt;hello world&lt;/h1&gt;&lt;/html&gt;"</span>
}

<span class="co">#' Echo the parameter that was sent in</span>
<span class="co">#' @param msg The message to echo back.</span>
<span class="co">#' @get /echo</span>
<span class="kw">function</span>(<span class="no">msg</span><span class="kw">=</span><span class="st">""</span>){
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">msg</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"The message is: '"</span>, <span class="no">msg</span>, <span class="st">"'"</span>))
}

<span class="co">#' Plot out data from the iris dataset</span>
<span class="co">#' @param spec If provided, filter the data to only this species (e.g. 'setosa')</span>
<span class="co">#' @get /plot</span>
<span class="co">#' @png</span>
<span class="kw">function</span>(<span class="no">spec</span>){
  <span class="no">myData</span> <span class="kw">&lt;-</span> <span class="no">iris</span>
  <span class="no">title</span> <span class="kw">&lt;-</span> <span class="st">"All Species"</span>

  <span class="co"># Filter if the species was specified</span>
  <span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/missing.html">missing</a></span>(<span class="no">spec</span>)){
    <span class="no">title</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Only the '"</span>, <span class="no">spec</span>, <span class="st">"' Species"</span>)
    <span class="no">myData</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="no">iris</span>, <span class="no">Species</span> <span class="kw">==</span> <span class="no">spec</span>)
  }

  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">myData</span>$<span class="no">Sepal.Length</span>, <span class="no">myData</span>$<span class="no">Petal.Length</span>,
       <span class="kw">main</span><span class="kw">=</span><span class="no">title</span>, <span class="kw">xlab</span><span class="kw">=</span><span class="st">"Sepal Length"</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">"Petal Length"</span>)
}</pre></body></html></div>
<ol start="2" style="list-style-type: decimal">
<li>Create a Dockerfile for the API - see bottom of page for how to do this automatically with <a href="https://o2r.info/containerit/" class="uri">https://o2r.info/containerit/</a>
</li>
</ol>
<p>The example folder has this Dockerfile:</p>
<pre><code>FROM gcr.io/gcer-public/googlecloudrunner:master
COPY ["./", "./"]
ENTRYPOINT ["R", "-e", "pr &lt;- plumber::plumb(commandArgs()[4]); pr$run(host='0.0.0.0', port=as.numeric(Sys.getenv('PORT')))"]
CMD ["api.R"]</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Deploy via the <code><a href="../reference/cr_deploy_run.html">cr_deploy_plumber()</a></code> function:</li>
</ol>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">googleCloudRunner</span>)

<span class="no">my_plumber_folder</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"example"</span>, <span class="kw">package</span><span class="kw">=</span><span class="st">"googleCloudRunner"</span>)
<span class="no">cr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_deploy_run.html">cr_deploy_plumber</a></span>(<span class="no">my_plumber_folder</span>)
<span class="co">#2019-11-12 10:34:29 -- File size detected as 903 bytes</span>
<span class="co">#2019-11-12 10:34:31&gt; Cloud Build started - logs: </span>
<span class="co">#https://console.cloud.google.com/gcr/builds/40343fd4-6981-41c3-98c8-f5973c3de386?project=1080525199262</span>

<span class="co">#Waiting for build to finish:</span>
<span class="co"># |===============||</span>
<span class="co">#Build finished</span>
<span class="co">#2019-11-12 10:35:43&gt; Deployed to Cloud Run at: </span>
<span class="co">#https://cloudrunnertest2-ewjogewawq-ew.a.run.app</span>
<span class="co">#==CloudRunService==</span>
<span class="co">#name:  cloudrunnertest2 </span>
<span class="co">#location:  europe-west1 </span>
<span class="co">#lastModifier:  1080525199262@cloudbuild.gserviceaccount.com </span>
<span class="co">#containers:  gcr.io/mark-edmondson-gde/cloudrunnertest2 </span>
<span class="co">#creationTimestamp:  2019-11-12T10:35:19.993128Z </span>
<span class="co">#observedGeneration:  1 </span>
<span class="co">#url:  https://cloudrunnertest2-ewjogewawq-ew.a.run.app </span></pre></body></html></div>
<ol start="4" style="list-style-type: decimal">
<li>Enjoy your API</li>
</ol>
<div id="rstudio-gadget---deploy-plumber-script" class="section level3">
<h3 class="hasAnchor">
<a href="#rstudio-gadget---deploy-plumber-script" class="anchor"></a>RStudio Gadget - deploy plumber script</h3>
<p>If you are using RStudio, installing the library will enable an <a href="https://rstudio.github.io/rstudioaddins/">RStudio Addin</a> that can be called after you have setup the library as per the setup page.</p>
<p>It includes a Shiny gadget that you can call via the Addin menu in RStudio, via <code><a href="../reference/cr_deploy_gadget.html">googleCloudRunner::cr_deploy_gadget()</a></code> or assigned to a hotkey (I use CTRL+SHIFT+D).</p>
<p>This sets up a Shiny UI to help smooth out deployments as pictured:</p>
<p><img src="gadget_plumber.png"></p>
</div>
<div id="what-did-it-do" class="section level3">
<h3 class="hasAnchor">
<a href="#what-did-it-do" class="anchor"></a>What did it do?</h3>
<p>Deployment via <code><a href="../reference/cr_deploy_run.html">cr_deploy_plumber()</a></code> automated these steps:</p>
<ol style="list-style-type: decimal">
<li>Uploads the Dockerfile and your api.R file to your Google Cloud Storage bucket</li>
<li>Creates a Cloud Build job for building the files uploaded to the GCS bucket, and pushes the Docker images to Google Container Registry</li>
<li>Deploys that container to Cloud Run</li>
</ol>
<p>It will launch a browser showing the build on Cloud Build, or you can wait for progress in your local R session. Upon successfully deployment it gives you a <code>CloudRunService</code> object with details of the deployment.</p>
<p>All the above stages can be customised for your own purposes, using the functions explained below.</p>
</div>
</div>
<div id="customising-cloud-run-deployments" class="section level2">
<h2 class="hasAnchor">
<a href="#customising-cloud-run-deployments" class="anchor"></a>Customising Cloud Run deployments</h2>
<p>The Cloud Run API is not called directly when deploying - instead a Cloud Build is created for deployment. <code>cr_run</code> creates a cloudbuild that make a cloud build including <code><a href="../reference/cr_buildstep_run.html">cr_buildstep_run()</a></code>.</p>
<p>You can build the deployment yourself by using <code><a href="../reference/cr_buildstep_run.html">cr_buildstep_run()</a></code> within your own <code><a href="../reference/cr_build.html">cr_build()</a></code>. This may cover things like downloading encrypted resources necessary for a build, running other code etc.</p>
<p>If you have an existing image you want to deploy on Cloud Run (usually one that serves up HTTP content, such as a website or via <code><a href="https://rdrr.io/pkg/plumber/man">library(plumber)</a></code>) then you only need to supply that image to deploy:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="../reference/cr_run.html">cr_run</a></span>(<span class="st">"gcr.io/my-project/my-image"</span>)</pre></body></html></div>
<p>Cloud Run needs <a href="https://cloud.google.com/run/docs/deploying">specific ports available in your container</a>, so you may want to consult the documentation if you do - in particular look at the <a href="https://cloud.google.com/run/docs/reference/container-contract">container contract</a> which specifies what the Docker container requirements are.</p>
<p>If you want to do the common use case of building the container first before deployment to Cloud Run, you can do so by using the helper <code><a href="../reference/cr_deploy_docker.html">cr_deploy_docker()</a></code>:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="../reference/cr_deploy_docker.html">cr_deploy_docker</a></span>(<span class="st">"my-image"</span>)

<span class="fu"><a href="../reference/cr_run.html">cr_run</a></span>(<span class="st">"gcr.io/my-project/my-image"</span>)</pre></body></html></div>
<p>If you want this in the same Cloud Build, then this is available via the buildsteps <code><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker()</a></code> and <code><a href="../reference/cr_buildstep_run.html">cr_buildstep_run()</a></code>.</p>
</div>
<div id="cloud-run-deployment-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#cloud-run-deployment-functions" class="anchor"></a>Cloud Run deployment functions</h2>
<ul>
<li><p><code><a href="../reference/cr_deploy_run.html">cr_deploy_run()</a></code> wraps the steps described above to build the Dockerfile, and deploy it to Cloud Run, setting authentication as needed.</p></li>
<li><p><code><a href="../reference/cr_deploy_run.html">cr_deploy_plumber()</a></code> adds checks for plumber API files. You need to make sure you have an <code>api.R</code> file in the deployment folder you provide, that will hold plumber code.</p></li>
<li><p><code><a href="../reference/cr_deploy_run.html">cr_deploy_html()</a></code> adds steps to deploy a nginx web server ready to serve the HTML files you supply.</p></li>
</ul>
</div>
<div id="pubsub" class="section level2">
<h2 class="hasAnchor">
<a href="#pubsub" class="anchor"></a>Pub/Sub</h2>
<p>Pub/Sub is a messaging service used throughout GCP to transfer messages to services. For instance, Cloud Storage objects being created, logging filter conditions, BigQuery table updates. It is useful to be able to react to these messages with R code which Cloud Run + Plumber enables by providing a HTTP endpoint for push Pub/Sub subscriptions.</p>
<p>A helper function is included with <code>googleCloudRunner</code> that decodes the standard pub/sub message into an R object. To use place the below function into your plumber script and deploy:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">pub</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>){<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Echo:"</span>, <span class="no">x</span>)}

<span class="co">#' Recieve pub/sub message</span>
<span class="co">#' @post /pubsub</span>
<span class="co">#' @param message a pub/sub message</span>
<span class="kw">function</span>(<span class="no">message</span><span class="kw">=</span><span class="kw">NULL</span>){
  <span class="kw pkg">googleCloudRunner</span><span class="kw ns">::</span><span class="fu"><a href="../reference/cr_plumber_pubsub.html">cr_plumber_pubsub</a></span>(<span class="no">message</span>, <span class="no">pub</span>)
}</pre></body></html></div>
<p>The <code>pub()</code> function can be any R code you like, so you can change it to trigger an analysis or other R tasks. The data within a pubsub message can also be used as a parameter to your code, such as an object name or timestamp of when the event fired. An example if also in the <a href="https://code.markedmondson.me/googleCloudRunner/articles/usecases.html#trigger-an-r-function-from-pubsub">use case section of the website</a></p>
</div>
<div id="creating-a-dockerfile-with-containerit" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-a-dockerfile-with-containerit" class="anchor"></a>Creating a Dockerfile with containerit</h2>
<p><code>containerit</code> is not yet on CRAN so can’t be packaged with the CRAN version of <code>googleCloudRunner</code> but its a useful package to work with since it auto-creates Dockerfiles from R files.</p>
<p>To install it use <code><a href="https://remotes.r-lib.org/reference/install_github.html">remotes::install_github("o2r-project/containerit")</a></code></p>
<p><a href="https://o2r.info/containerit/">See <code>containerit</code>s website for more details</a> on how to use it.</p>
<p>An example of using it to help create plumber Dockerfiles is below:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r">library(containerit)
cr_dockerfile_plumber &lt;- function(deploy_folder, ...){
  docker &lt;- dockerfile(
      deploy_folder,
      image = "trestletech/plumber",
      offline = FALSE,
      cmd = Cmd("api.R"),
      maintainer = NULL,
      copy = list("./"),
      container_workdir = NULL,
      entrypoint = Entrypoint("R",
                       params = list(
        "-e",
       "pr &lt;- plumber::plumb(commandArgs()[4]); pr$run(host='0.0.0.0', port=as.numeric(Sys.getenv('PORT')))")
       ),
      filter_baseimage_pkgs = FALSE,
      ...))

  write_to &lt;- file.path(deploy_folder, "Dockerfile")
  
  write(docker, file = write_to)

  assert_that(
    is.readable(write_to)
  )

  message("Written Dockerfile to ", write_to, level = 3)
  print(docker)
  docker

}</pre></body></html></div>
</div>
<div id="deploying-from-another-google-cloud-project" class="section level2">
<h2 class="hasAnchor">
<a href="#deploying-from-another-google-cloud-project" class="anchor"></a>Deploying from another Google Cloud project</h2>
<p>By default the build will only allow deployments from the same Google Cloud Project - if you want to deploy container images from other projects you need to give the Cloud Run Service Agent for the Cloud Run project access to the source project. See this <a href="https://cloud.google.com/run/docs/deploying#other-projects">Google help file</a>.</p>
<p>This is available via the <code><a href="../reference/cr_setup_service.html">cr_setup_service()</a></code> function, using the role lookup <code><a href="../reference/cr_setup_service.html">cr_setup_role_lookup("run_agent")</a></code>:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r">cr_setup_service("service-{project-number}@serverless-robot-prod.iam.gserviceaccount.com"
                 roles = cr_setup_role_lookup("run_agent"))</pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
