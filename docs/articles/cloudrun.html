<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R on Cloud Run • googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="R on Cloud Run">
<meta property="og:description" content="googleCloudRunner">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-wrench"></span>
     
    Setup
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/setup.html">R Setup</a>
    </li>
    <li>
      <a href="../articles/setup-gcp.html">GCP Setup</a>
    </li>
    <li>
      <a href="../articles/git.html">Git Setup</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/usecase-r-api-microservices.html">R API Microservices</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-cloudrun.html">Deploy Shiny on Cloud Run</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-kubernetes.html">Deploy Shiny on Kubernetes</a>
    </li>
    <li>
      <a href="../articles/usecase-package-docker-build.html">R Package Tools: Auto Docker images</a>
    </li>
    <li>
      <a href="../articles/usecase-testthat-coverage.html">R Package Tools: Testthat coverage</a>
    </li>
    <li>
      <a href="../articles/usecase-deploy-pkgdown-website.html">R Package Tools: Pkgdown websites</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-r-builds.html">Scheduled R scripts in the Cloud</a>
    </li>
    <li>
      <a href="../articles/usecase-r-results-github.html">Save R output to GitHub</a>
    </li>
    <li>
      <a href="../articles/usecase-polygot-ga-imports-to-bigquery.html">Integrating R with other languages</a>
    </li>
    <li>
      <a href="../articles/usecase-r-event-driven-pubsub.html">Event-triggered R scripts with pub/sub</a>
    </li>
    <li>
      <a href="../articles/usecase-slackbot-google-analytics.html">Create a Slackbot downloading Google Analytics</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-google-analytics.html">Schedule Google Analytics User Deletion API</a>
    </li>
    <li>
      <a href="../articles/usecase-rmarkdown-cloudrun.html">On-demand parameterised R Markdown reports</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>R on Cloud Run</h1>
            
            <h4 data-toc-skip class="date">2022-03-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/blob/HEAD/vignettes/cloudrun.Rmd" class="external-link"><code>vignettes/cloudrun.Rmd</code></a></small>
      <div class="hidden name"><code>cloudrun.Rmd</code></div>

    </div>

    
    
<p><a href="https://cloud.run" class="external-link">Cloud Run</a> is a service that lets you
deploy container images without worrying about the underlying servers or
infrastructure. It is called with <code><a href="../reference/cr_run.html">cr_run()</a></code>, or you can
automate a deployment via <code><a href="../reference/cr_deploy_run.html">cr_deploy_run()</a></code>.</p>
<p>If you would like to have your R code react in realtime to events
such as HTTP or Pub/Sub events, such as a website or API endpoint, Cloud
Run is a good fit.</p>
<p>If you want to run scripts that can be triggered one time, setup to
trigger on GitHub events or pub/sub, or scheduled using Cloud Scheduler
then <a href="https://code.markedmondson.me/googleCloudRunner/articles/cloudbuild.html">Cloud
Build</a> is more suited to your use case.</p>
<p>An overview of the functionality available is in this diagram:</p>
<p><img src="cloudrun_plot.png"></p>
<div class="section level2">
<h2 id="quickstart---plumber-api">Quickstart - plumber API<a class="anchor" aria-label="anchor" href="#quickstart---plumber-api"></a>
</h2>
<ol style="list-style-type: decimal">
<li>Make an R API via <a href="https://www.rplumber.io/" class="external-link">plumber</a>
that contains entry file api.R. You can use the demo example in
<code>system.file("example", package="googleCloudRunner")</code> if you
like, which is reproduced below:</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' @get /</span>
<span class="co">#' @html</span>
<span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
  <span class="st">"&lt;html&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/html&gt;"</span>
<span class="op">}</span>


<span class="co">#' @get /hello</span>
<span class="co">#' @html</span>
<span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
  <span class="st">"&lt;html&gt;&lt;h1&gt;hello world&lt;/h1&gt;&lt;/html&gt;"</span>
<span class="op">}</span>

<span class="co">#' Echo the parameter that was sent in</span>
<span class="co">#' @param msg The message to echo back.</span>
<span class="co">#' @get /echo</span>
<span class="kw">function</span><span class="op">(</span><span class="va">msg</span><span class="op">=</span><span class="st">""</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>msg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"The message is: '"</span>, <span class="va">msg</span>, <span class="st">"'"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">#' Plot out data from the iris dataset</span>
<span class="co">#' @param spec If provided, filter the data to only this species (e.g. 'setosa')</span>
<span class="co">#' @get /plot</span>
<span class="co">#' @png</span>
<span class="kw">function</span><span class="op">(</span><span class="va">spec</span><span class="op">)</span><span class="op">{</span>
  <span class="va">myData</span> <span class="op">&lt;-</span> <span class="va">iris</span>
  <span class="va">title</span> <span class="op">&lt;-</span> <span class="st">"All Species"</span>

  <span class="co"># Filter if the species was specified</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/missing.html" class="external-link">missing</a></span><span class="op">(</span><span class="va">spec</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">title</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Only the '"</span>, <span class="va">spec</span>, <span class="st">"' Species"</span><span class="op">)</span>
    <span class="va">myData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">Species</span> <span class="op">==</span> <span class="va">spec</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">myData</span><span class="op">$</span><span class="va">Sepal.Length</span>, <span class="va">myData</span><span class="op">$</span><span class="va">Petal.Length</span>,
       main<span class="op">=</span><span class="va">title</span>, xlab<span class="op">=</span><span class="st">"Sepal Length"</span>, ylab<span class="op">=</span><span class="st">"Petal Length"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Create a Dockerfile for the API - see bottom of page for how to do
this automatically with <a href="https://o2r.info/containerit/" class="external-link uri">https://o2r.info/containerit/</a>
</li>
</ol>
<p>The example folder has this Dockerfile:</p>
<pre><code>FROM gcr.io/gcer-public/googlecloudrunner:master
COPY ["./", "./"]
ENTRYPOINT ["R", "-e", "pr &lt;- plumber::plumb(commandArgs()[4]); pr$run(host='0.0.0.0', port=as.numeric(Sys.getenv('PORT')))"]
CMD ["api.R"]</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Deploy via the <code><a href="../reference/cr_deploy_run.html">cr_deploy_plumber()</a></code> function:</li>
</ol>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudRunner/">googleCloudRunner</a></span><span class="op">)</span>

<span class="va">my_plumber_folder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"example"</span>, package<span class="op">=</span><span class="st">"googleCloudRunner"</span><span class="op">)</span>
<span class="va">cr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_deploy_run.html">cr_deploy_plumber</a></span><span class="op">(</span><span class="va">my_plumber_folder</span><span class="op">)</span>
<span class="co">#2019-11-12 10:34:29 -- File size detected as 903 bytes</span>
<span class="co">#2019-11-12 10:34:31&gt; Cloud Build started - logs: </span>
<span class="co">#https://console.cloud.google.com/gcr/builds/40343fd4-6981-41c3-98c8-f5973c3de386?project=1080525199262</span>

<span class="co">#Waiting for build to finish:</span>
<span class="co"># |===============||</span>
<span class="co">#Build finished</span>
<span class="co">#2019-11-12 10:35:43&gt; Deployed to Cloud Run at: </span>
<span class="co">#https://cloudrunnertest2-ewjogewawq-ew.a.run.app</span>
<span class="co">#==CloudRunService==</span>
<span class="co">#name:  cloudrunnertest2 </span>
<span class="co">#location:  europe-west1 </span>
<span class="co">#lastModifier:  1080525199262@cloudbuild.gserviceaccount.com </span>
<span class="co">#containers:  gcr.io/mark-edmondson-gde/cloudrunnertest2 </span>
<span class="co">#creationTimestamp:  2019-11-12T10:35:19.993128Z </span>
<span class="co">#observedGeneration:  1 </span>
<span class="co">#url:  https://cloudrunnertest2-ewjogewawq-ew.a.run.app </span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Enjoy your API</li>
</ol>
<div class="section level3">
<h3 id="rstudio-gadget---deploy-plumber-script">RStudio Gadget - deploy plumber script<a class="anchor" aria-label="anchor" href="#rstudio-gadget---deploy-plumber-script"></a>
</h3>
<p>If you are using RStudio, installing the library will enable an <a href="https://rstudio.github.io/rstudioaddins/" class="external-link">RStudio Addin</a> that
can be called after you have setup the library as per the setup
page.</p>
<p>It includes a Shiny gadget that you can call via the Addin menu in
RStudio, via <code><a href="../reference/cr_deploy_gadget.html">googleCloudRunner::cr_deploy_gadget()</a></code> or
assigned to a hotkey (I use CTRL+SHIFT+D).</p>
<p>This sets up a Shiny UI to help smooth out deployments as
pictured:</p>
<p><img src="gadget_plumber.png"></p>
</div>
<div class="section level3">
<h3 id="what-did-it-do">What did it do?<a class="anchor" aria-label="anchor" href="#what-did-it-do"></a>
</h3>
<p>Deployment via <code><a href="../reference/cr_deploy_run.html">cr_deploy_plumber()</a></code> automated these
steps:</p>
<ol style="list-style-type: decimal">
<li>Uploads the Dockerfile and your api.R file to your Google Cloud
Storage bucket</li>
<li>Creates a Cloud Build job for building the files uploaded to the GCS
bucket, and pushes the Docker images to Google Container Registry</li>
<li>Deploys that container to Cloud Run</li>
</ol>
<p>It will launch a browser showing the build on Cloud Build, or you can
wait for progress in your local R session. Upon successfully deployment
it gives you a <code>CloudRunService</code> object with details of the
deployment.</p>
<p>All the above stages can be customised for your own purposes, using
the functions explained below.</p>
</div>
</div>
<div class="section level2">
<h2 id="customising-cloud-run-deployments">Customising Cloud Run deployments<a class="anchor" aria-label="anchor" href="#customising-cloud-run-deployments"></a>
</h2>
<p>The Cloud Run API is not called directly when deploying - instead a
Cloud Build is created for deployment. <code>cr_run</code> creates a
cloudbuild that makes a cloud build including
<code><a href="../reference/cr_buildstep_run.html">cr_buildstep_run()</a></code>.</p>
<p>You can build the deployment yourself by using
<code><a href="../reference/cr_buildstep_run.html">cr_buildstep_run()</a></code> within your own <code><a href="../reference/cr_build.html">cr_build()</a></code>.
This may cover things like downloading encrypted resources necessary for
a build, running other code etc.</p>
<p>If you have an existing image you want to deploy on Cloud Run
(usually one that serves up HTTP content, such as a website or via
<code><a href="https://www.rplumber.io" class="external-link">library(plumber)</a></code>) then you only need to supply that image
to deploy:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/cr_run.html">cr_run</a></span><span class="op">(</span><span class="st">"gcr.io/my-project/my-image"</span><span class="op">)</span></code></pre></div>
<p>Cloud Run needs <a href="https://cloud.google.com/run/docs/deploying" class="external-link">specific ports
available in your container</a>, so you may want to consult the
documentation if you do - in particular look at the <a href="https://cloud.google.com/run/docs/reference/container-contract" class="external-link">container
contract</a> which specifies what the Docker container requirements
are.</p>
<p>If you want to do the common use case of building the container first
before deployment to Cloud Run, you can do so by using the helper
<code><a href="../reference/cr_deploy_docker.html">cr_deploy_docker()</a></code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/cr_deploy_docker.html">cr_deploy_docker</a></span><span class="op">(</span><span class="st">"my-image"</span><span class="op">)</span>

<span class="fu"><a href="../reference/cr_run.html">cr_run</a></span><span class="op">(</span><span class="st">"gcr.io/my-project/my-image"</span><span class="op">)</span></code></pre></div>
<p>If you want this in the same Cloud Build, then this is available via
the buildsteps <code><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker()</a></code> and
<code><a href="../reference/cr_buildstep_run.html">cr_buildstep_run()</a></code>.</p>
</div>
<div class="section level2">
<h2 id="cloud-run-deployment-functions">Cloud Run deployment functions<a class="anchor" aria-label="anchor" href="#cloud-run-deployment-functions"></a>
</h2>
<ul>
<li><p><code><a href="../reference/cr_deploy_run.html">cr_deploy_run()</a></code> wraps the steps described above to
build the Dockerfile, and deploys it to Cloud Run, setting
authentication as needed.</p></li>
<li><p><code><a href="../reference/cr_deploy_run.html">cr_deploy_plumber()</a></code> adds checks for plumber API
files. You need to make sure you have an <code>api.R</code> file in the
deployment folder you provide, that will hold plumber code.</p></li>
<li><p><code><a href="../reference/cr_deploy_run.html">cr_deploy_html()</a></code> adds steps to deploy a nginx web
server ready to serve the HTML files you supply.</p></li>
</ul>
<div class="section level3">
<h3 id="regions">Regions<a class="anchor" aria-label="anchor" href="#regions"></a>
</h3>
<p>You can deploy to any GCP region that supports Cloud Run. A list is
maintained and updated from the latest package build that you can see in
<code><a href="../reference/cr_regions.html">googleCloudRunner::cr_regions</a></code></p>
</div>
</div>
<div class="section level2">
<h2 id="pubsub">Pub/Sub<a class="anchor" aria-label="anchor" href="#pubsub"></a>
</h2>
<p>Pub/Sub is a messaging service used throughout GCP to transfer
messages to services. For instance, Cloud Storage objects being created,
logging filter conditions, BigQuery table updates. It is useful to be
able to react to these messages with R code which Cloud Run + Plumber
enables by providing a HTTP endpoint for push Pub/Sub subscriptions.</p>
<p>A helper function is included with <code>googleCloudRunner</code>
that decodes the standard pub/sub message into an R object. To use place
the below function into your plumber script and deploy:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pub</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Echo:"</span>, <span class="va">x</span><span class="op">)</span><span class="op">}</span>

<span class="co">#' Recieve pub/sub message</span>
<span class="co">#' @post /pubsub</span>
<span class="co">#' @param message a pub/sub message</span>
<span class="kw">function</span><span class="op">(</span><span class="va">message</span><span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">{</span>
  <span class="fu">googleCloudRunner</span><span class="fu">::</span><span class="fu"><a href="../reference/cr_plumber_pubsub.html">cr_plumber_pubsub</a></span><span class="op">(</span><span class="va">message</span>, <span class="va">pub</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The <code>pub()</code> function can be any R code you like, so you
can change it to trigger an analysis or other R tasks. The data within a
pubsub message can also be used as a parameter to your code, such as an
object name or timestamp of when the event fired. An example if also in
the <a href="https://code.markedmondson.me/googleCloudRunner/articles/usecases.html#trigger-an-r-function-from-pubsub">use
case section of the website</a></p>
</div>
<div class="section level2">
<h2 id="creating-a-dockerfile-with-containerit">Creating a Dockerfile with containerit<a class="anchor" aria-label="anchor" href="#creating-a-dockerfile-with-containerit"></a>
</h2>
<p><code>containerit</code> is not yet on CRAN so can’t be packaged with
the CRAN version of <code>googleCloudRunner</code> but its a useful
package to work with since it auto-creates Dockerfiles from R files.</p>
<p>To install it use
<code>remotes::install_github("o2r-project/containerit")</code></p>
<p><a href="https://o2r.info/containerit/" class="external-link">See <code>containerit</code>s
website for more details</a> on how to use it.</p>
<p>An example of using it to help create plumber Dockerfiles is
below:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(containerit)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>cr_dockerfile_plumber <span class="ot">&lt;-</span> <span class="cf">function</span>(deploy_folder, ...){</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  docker <span class="ot">&lt;-</span> <span class="fu">dockerfile</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>      deploy_folder,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">image =</span> <span class="st">"trestletech/plumber"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">offline =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">cmd =</span> <span class="fu">Cmd</span>(<span class="st">"api.R"</span>),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">maintainer =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">copy =</span> <span class="fu">list</span>(<span class="st">"./"</span>),</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">container_workdir =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">entrypoint =</span> <span class="fu">Entrypoint</span>(<span class="st">"R"</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>                       <span class="at">params =</span> <span class="fu">list</span>(</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-e"</span>,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>       <span class="st">"pr &lt;- plumber::plumb(commandArgs()[4]); pr$run(host='0.0.0.0', port=as.numeric(Sys.getenv('PORT')))"</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>       ),</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">filter_baseimage_pkgs =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>      ...)<span class="er">)</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  write_to <span class="ot">&lt;-</span> <span class="fu">file.path</span>(deploy_folder, <span class="st">"Dockerfile"</span>)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write</span>(docker, <span class="at">file =</span> write_to)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assert_that</span>(</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.readable</span>(write_to)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Written Dockerfile to "</span>, write_to, <span class="at">level =</span> <span class="dv">3</span>)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(docker)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  docker</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="deploying-shiny-to-cloud-run">Deploying Shiny to Cloud Run<a class="anchor" aria-label="anchor" href="#deploying-shiny-to-cloud-run"></a>
</h2>
<p>Due to Shiny’s stateful nature, Cloud Run is not a perfect fit for
Shiny but it can be configured to run Shiny apps that scale to 0
(e.g. no cost) up to 80 connections at once to one instance. The one
instance is necessary to avoid requests being sent to another Shiny
container instance and losing the user session. Shiny also needs to have
certain websocket features disabled, and there is a 15min session
timeout.</p>
<p>This means you can’t scale to a billion like other Cloud Run apps,
and need to keep an eye on the load of the Shiny app (which will depend
on your code) to see if 80 connections are too much for the CPU and
Memory you assign to the Cloud Run instance. However this should still
be a good fit for a lot of data science applications.</p>
<p>A minimal working example has been created by <span class="citation">@randy3k</span> here: <a href="https://github.com/randy3k/shiny-cloudrun-demo" class="external-link uri">https://github.com/randy3k/shiny-cloudrun-demo</a> which can
be deployed to Cloud Run via a fork here:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudRunner/">googleCloudRunner</a></span><span class="op">)</span>

<span class="co"># a repo with the Dockerfile template</span>
<span class="va">repo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo</a></span><span class="op">(</span><span class="st">"MarkEdmondson1234/shiny-cloudrun-demo"</span><span class="op">)</span>

<span class="co"># deploy a cloud build trigger so each commit build the image</span>
<span class="fu"><a href="../reference/cr_deploy_docker_trigger.html">cr_deploy_docker_trigger</a></span><span class="op">(</span>
  <span class="va">repo</span>,
  image <span class="op">=</span> <span class="st">"shiny-cloudrun"</span>
<span class="op">)</span>

<span class="co"># deploy to Cloud Run</span>
<span class="fu"><a href="../reference/cr_run.html">cr_run</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"gcr.io/%s/shiny-cloudrun:latest"</span>,<span class="fu"><a href="../reference/cr_project_set.html">cr_project_get</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,
       name <span class="op">=</span> <span class="st">"shiny-cloudrun"</span>,
       concurrency <span class="op">=</span> <span class="fl">80</span>,
       max_instances <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>If you need to change the memory for the one instance, you can use
<code>cpu</code> and <code>memory</code> arguments in the
<code><a href="../reference/cr_buildstep_run.html">cr_buildstep_run()</a></code> and subsequent functions such as
<code><a href="../reference/cr_run.html">cr_run()</a></code>. The maximum allowed is 2 CPUs and 2 gibibytes
(<code>2Gi</code>):</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># deploy to Cloud Run with 2GBs of RAM per instance and 2 CPUs</span>
<span class="fu"><a href="../reference/cr_run.html">cr_run</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"gcr.io/%s/shiny-cloudrun:latest"</span>,<span class="fu"><a href="../reference/cr_project_set.html">cr_project_get</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,
       name <span class="op">=</span> <span class="st">"shiny-cloudrun"</span>,
       concurrency <span class="op">=</span> <span class="fl">80</span>,
       max_instances <span class="op">=</span> <span class="fl">1</span>,
       cpu <span class="op">=</span> <span class="fl">2</span>,
       memory <span class="op">=</span> <span class="st">"2Gi"</span><span class="op">)</span></code></pre></div>
<p>Or if you have a local Shiny app in <code>shiny_cloudrun/</code> with
the appropriate Dockerfile and Shiny configuration, the full Docker
build and deployment pipeline can be carried out with:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># deploy the app version from this folder</span>
<span class="fu"><a href="../reference/cr_deploy_run.html">cr_deploy_run</a></span><span class="op">(</span><span class="st">"shiny_cloudrun/"</span>,
              remote <span class="op">=</span> <span class="st">"shiny-cloudrun2"</span>,
              tag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"latest"</span>,<span class="st">"$BUILD_ID"</span><span class="op">)</span>,
              max_instances <span class="op">=</span> <span class="fl">1</span>, <span class="co"># required for shiny</span>
              concurrency <span class="op">=</span> <span class="fl">80</span><span class="op">)</span></code></pre></div>
<div class="section level3">
<h3 id="shiny-app-on-cloud-run-with-googleauthr-authentication">Shiny app on Cloud Run with googleAuthR authentication<a class="anchor" aria-label="anchor" href="#shiny-app-on-cloud-run-with-googleauthr-authentication"></a>
</h3>
<p>If you want to have authentication options for the user as they visit
the app on Cloud Run, the below is a working example that is deployed
here:
<code>https://shiny-cloudrun-sc-ewjogewawq-ew.a.run.app/</code></p>
<p>Folder:</p>
<pre><code>|
|- app.R
|- Dockerfile
|- client.json
|- shiny-customized.config</code></pre>
<div class="section level4">
<h4 id="app-r">app.R<a class="anchor" aria-label="anchor" href="#app-r"></a>
</h4>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.rstudio.com/" class="external-link">shiny</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://code.markedmondson.me/searchConsoleR/" class="external-link">searchConsoleR</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleAuthR/" class="external-link">googleAuthR</a></span><span class="op">)</span>

<span class="fu"><a href="https://code.markedmondson.me/googleAuthR//reference/gar_set_client.html" class="external-link">gar_set_client</a></span><span class="op">(</span>web_json <span class="op">=</span> <span class="st">"client.json"</span>,
               scopes <span class="op">=</span> <span class="st">"https://www.googleapis.com/auth/webmasters"</span><span class="op">)</span>

<span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html" class="external-link">fluidPage</a></span><span class="op">(</span>
  <span class="fu">googleAuth_jsUI</span><span class="op">(</span><span class="st">'auth'</span>, login_text <span class="op">=</span> <span class="st">'Login to Google'</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderTable.html" class="external-link">tableOutput</a></span><span class="op">(</span><span class="st">"sc_accounts"</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">auth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/callModule.html" class="external-link">callModule</a></span><span class="op">(</span><span class="va">googleAuth_js</span>, <span class="st">"auth"</span><span class="op">)</span>

  <span class="va">sc_accounts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html" class="external-link">reactive</a></span><span class="op">(</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/req.html" class="external-link">req</a></span><span class="op">(</span><span class="fu">auth</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

    <span class="fu">with_shiny</span><span class="op">(</span>
      <span class="va">list_websites</span>,
      shiny_access_token <span class="op">=</span> <span class="fu">auth</span><span class="op">(</span><span class="op">)</span>
    <span class="op">)</span>

  <span class="op">}</span><span class="op">)</span>

  <span class="va">output</span><span class="op">$</span><span class="va">sc_accounts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderTable.html" class="external-link">renderTable</a></span><span class="op">(</span><span class="op">{</span>
    <span class="fu">sc_accounts</span><span class="op">(</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>


<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html" class="external-link">shinyApp</a></span><span class="op">(</span>ui <span class="op">=</span> <span class="va">ui</span>, server <span class="op">=</span> <span class="va">server</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="dockerfile">Dockerfile<a class="anchor" aria-label="anchor" href="#dockerfile"></a>
</h4>
<pre><code>FROM rocker/shiny

# install R package dependencies
RUN apt-get update &amp;&amp; apt-get install -y \
    libcurl4-openssl-dev libssl-dev \
    ## clean up
    &amp;&amp; apt-get clean \
    &amp;&amp; rm -rf /var/lib/apt/lists/ \
    &amp;&amp; rm -rf /tmp/downloaded_packages/ /tmp/*.rds

## Install packages from CRAN
RUN install2.r --error \
    -r 'http://cran.rstudio.com' \
    googleAuthR searchConsoleR

COPY shiny-customized.config /etc/shiny-server/shiny-server.conf
COPY client.json /srv/shiny-server/client.json
COPY app.R /srv/shiny-server/app.R

EXPOSE 8080

USER shiny

# avoid s6 initialization
# see https://github.com/rocker-org/shiny/issues/79
CMD ["/usr/bin/shiny-server"]</code></pre>
</div>
<div class="section level4">
<h4 id="client-id-and-gcp-setup">client.id and GCP setup<a class="anchor" aria-label="anchor" href="#client-id-and-gcp-setup"></a>
</h4>
<p>The client.json was a web client json from my project:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">"web"</span><span class="fu">:{</span><span class="dt">"client_id"</span><span class="fu">:</span><span class="st">"10XXX"</span><span class="fu">,</span><span class="dt">"project_id"</span><span class="fu">:</span><span class="st">"XXXX"</span><span class="fu">,</span><span class="dt">"auth_uri"</span><span class="fu">:</span><span class="st">"https://accounts.google.com/o/oauth2/auth"</span><span class="fu">,</span><span class="dt">"token_uri"</span><span class="fu">:</span><span class="st">"https://accounts.google.com/o/oauth2/token"</span><span class="fu">,</span><span class="dt">"auth_provider_x509_cert_url"</span><span class="fu">:</span><span class="st">"https://www.googleapis.com/oauth2/v1/certs"</span><span class="fu">,</span><span class="dt">"client_secret"</span><span class="fu">:</span><span class="st">"XXXXX"</span><span class="fu">,</span><span class="dt">"redirect_uris"</span><span class="fu">:</span><span class="ot">[</span><span class="st">"http://localhost"</span><span class="ot">]</span><span class="fu">,</span><span class="dt">"javascript_origins"</span><span class="fu">:</span><span class="ot">[</span><span class="st">"https://www.example.com"</span><span class="ot">,</span><span class="st">"http://localhost:1221"</span><span class="ot">]</span><span class="fu">}}</span></span></code></pre></div>
<p>You need to add the domain of where the Cloud Run is running in the
JavaScript origins within the GCP console, that you get after deploying
the app. (GCP console &gt; APIs &amp; Services &gt; Crdentials &gt;
Click on the Web Client ID you are using &gt; Add URL to Authorised
JavaScript origins).</p>
<p><img src="javascript-origins.png"></p>
<p>In the example case this is
<code>https://shiny-cloudrun-sc-ewjogewawq-ew.a.run.app/</code></p>
</div>
<div class="section level4">
<h4 id="shiny-customized-config">shiny-customized.config<a class="anchor" aria-label="anchor" href="#shiny-customized-config"></a>
</h4>
<p>This is the configuration file for Shiny that will overwrite the
default one - its main purpose is turning off the websocket
functionality that is not supported on Cloud Run</p>
<pre><code>disable_protocols websocket xdr-streaming xhr-streaming iframe-eventsource iframe-htmlfile xdr-polling iframe-xhr-polling;

run_as shiny;

server {
  listen 8080;

  location / {
    site_dir /srv/shiny-server;

    log_dir /var/log/shiny-server;

    directory_index off;
  }
}</code></pre>
</div>
<div class="section level4">
<h4 id="deploying">Deploying<a class="anchor" aria-label="anchor" href="#deploying"></a>
</h4>
<p>You can then deploy similar to the example above, which will build
the Dockerfile and then deploy it to Cloud Run.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># deploy the app version from this folder</span>
<span class="fu"><a href="../reference/cr_deploy_run.html">cr_deploy_run</a></span><span class="op">(</span><span class="st">"shiny_cloudrun/app/"</span>,
              remote <span class="op">=</span> <span class="st">"shiny-cloudrun-sc"</span>,
              tag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"latest"</span>,<span class="st">"$BUILD_ID"</span><span class="op">)</span>,
              max_instances <span class="op">=</span> <span class="fl">1</span>, <span class="co"># required for shiny</span>
              concurrency <span class="op">=</span> <span class="fl">80</span><span class="op">)</span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="accessing-authenticated-cloud-run-apps">Accessing authenticated Cloud Run apps<a class="anchor" aria-label="anchor" href="#accessing-authenticated-cloud-run-apps"></a>
</h2>
<p>When deploying via <code><a href="../reference/cr_run.html">cr_run()</a></code> or otherwise you have the
option to only allowed authenticated requests to your app by setting the
argument <code>allowUnauthenticated=FALSE</code>. This lets you deploy
private docker containers and only allow requests from users or services
that have the correct JSON Web Token (JWT) in their headers. Note this
is distinct from OAuth2 access, which will not work.</p>
<p>The accessing of those services are <a href="https://cloud.google.com/run/docs/authenticating/overview" class="external-link">documented
here</a> and can be reached by any service that can make HTTP requests
and has the appropriate authorisation via a service account key.</p>
<p>To enable easier access from R the <code><a href="../reference/cr_jwt_create.html">cr_jwt_create()</a></code>
functions let you use your own local service account key to generate
appropriate JWTs, so as to be able to access the private Cloud Run
URL.</p>
<p>A demo is below, assuming you have already deployed the private Cloud
Run service:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># The private authenticated access only Cloud Run service</span>
<span class="va">the_url</span> <span class="op">&lt;-</span> <span class="st">"https://authenticated-cloudrun-ewjogewawq-ew.a.run.app/"</span>

<span class="co"># creating the JWT and token from your service account key used for googleCloudRunner</span>
<span class="va">jwt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_jwt_create.html">cr_jwt_create</a></span><span class="op">(</span><span class="va">the_url</span>, service_json <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"GCE_AUTH_FILE"</span><span class="op">)</span><span class="op">)</span>
<span class="va">token</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_jwt_create.html">cr_jwt_token</a></span><span class="op">(</span><span class="va">jwt</span>, <span class="va">the_url</span><span class="op">)</span>

<span class="co"># call Cloud Run app using token with any httr verb</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://httr.r-lib.org/" class="external-link">httr</a></span><span class="op">)</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">cr_jwt_with</span><span class="op">(</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span><span class="st">"https://authenticated-cloudrun-ewjogewawq-ew.a.run.app/hello"</span><span class="op">)</span>,
                   <span class="va">token</span><span class="op">)</span>
<span class="fu"><a href="https://httr.r-lib.org/reference/content.html" class="external-link">content</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="scheduling-cloud-run-applications">Scheduling Cloud Run applications<a class="anchor" aria-label="anchor" href="#scheduling-cloud-run-applications"></a>
</h2>
<p>Via <a href="https://code.markedmondson.me/googleCloudRunner/articles/cloudscheduler.html">Cloud
Scheduler</a> you can set up a scheduled hit of your HTTP endpoints, via
GET, POST or any other methods you have coded into your app.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># get your previously deployed Cloud Run app</span>
<span class="va">my_app</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_run_get.html">cr_run_get</a></span><span class="op">(</span><span class="st">"your-cloud-run"</span><span class="op">)</span>

<span class="co"># add any URL parameters your app needs etc.</span>
<span class="va">endpoint</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">my_app</span><span class="op">$</span><span class="va">status</span><span class="op">$</span><span class="va">url</span>, <span class="st">"?msg=blah"</span><span class="op">)</span>

<span class="co"># make the HTTP target</span>
<span class="va">run_me</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/HttpTarget.html">HttpTarget</a></span><span class="op">(</span>uri <span class="op">=</span> <span class="va">endpoint</span>, httpMethod <span class="op">=</span> <span class="st">"GET"</span><span class="op">)</span>

<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"cloud-run-scheduled"</span>, schedule <span class="op">=</span> <span class="st">"4 16 * * *"</span>, httpTarget <span class="op">=</span> <span class="va">run_me</span><span class="op">)</span></code></pre></div>
<div class="section level3">
<h3 id="private-cloud-run-service-scheduling">Private Cloud Run service scheduling<a class="anchor" aria-label="anchor" href="#private-cloud-run-service-scheduling"></a>
</h3>
<p><code><a href="../reference/cr_run_schedule_http.html">cr_run_schedule_http()</a></code> will help you create the HTTP
endpoint for you to pass to <code><a href="../reference/cr_schedule.html">cr_schedule()</a></code> that will work
with Cloud Run apps with <code>allowUnauthenticated = FALSE</code> - it
will by default create a service email for invoking your app called
<code>{your-app}-cloudrun-invoker@{your-project}.iam.gserviceaccount.com</code></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># deploy a non-public app</span>
<span class="fu"><a href="../reference/cr_deploy_run.html">cr_deploy_run</a></span><span class="op">(</span><span class="st">"your-cloud-run"</span>, allowUnauthenticated <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co"># get your previously deployed Cloud Run app</span>
<span class="va">my_app</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_run_get.html">cr_run_get</a></span><span class="op">(</span><span class="st">"your-cloud-run"</span><span class="op">)</span>

<span class="co"># add any URL parameters your app needs etc.</span>
<span class="va">endpoint</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">my_app</span><span class="op">$</span><span class="va">status</span><span class="op">$</span><span class="va">url</span>, <span class="st">"?msg=blah"</span><span class="op">)</span>

<span class="co"># generate the service email invoker that was created upon deployment</span>
<span class="co"># "your-cloud-run-cloudrun-invoke@your-project.iam.gserviceaccount.com"</span>
<span class="va">email</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_run_email.html">cr_run_email</a></span><span class="op">(</span><span class="st">"your-cloud-run"</span><span class="op">)</span>

<span class="co"># make the HTTP target for authenticated access only</span>
<span class="va">run_me</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_run_schedule_http.html">cr_run_schedule_http</a></span><span class="op">(</span><span class="va">endpoint</span>, email <span class="op">=</span> <span class="va">email</span>, http_method <span class="op">=</span> <span class="st">"GET"</span><span class="op">)</span>

<span class="co"># schedule the call to the endpoint of your Cloud run app</span>
<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"cloud-run-scheduled"</span>, schedule <span class="op">=</span> <span class="st">"4 16 * * *"</span>, httpTarget <span class="op">=</span> <span class="va">run_me</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="deploying-from-another-google-cloud-project">Deploying from another Google Cloud project<a class="anchor" aria-label="anchor" href="#deploying-from-another-google-cloud-project"></a>
</h2>
<p>By default the build will only allow deployments from the same Google
Cloud Project - if you want to deploy container images from other
projects you need to give the Cloud Run Service Agent for the Cloud Run
project access to the source project. See this <a href="https://cloud.google.com/run/docs/deploying#other-projects" class="external-link">Google
help file</a>.</p>
<p>This is available via the <code><a href="../reference/cr_setup_service.html">cr_setup_service()</a></code> function,
using the role lookup
<code>cr_setup_role_lookup("run_agent")</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cr_setup_service</span>(<span class="st">"service-{project-number}@serverless-robot-prod.iam.gserviceaccount.com"</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">roles =</span> <span class="fu">cr_setup_role_lookup</span>(<span class="st">"run_agent"</span>))</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>
2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
